#!/usr/bin/make -f
DH_VERBOSE = 1
export DH_OPTIONS=-v

DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/default.mk

%:
	dh $@  --with autotools-dev

BUILD_ROOT=$(shell pwd)
override_dh_auto_configure:
override_dh_auto_build:
override_dh_auto_test:
override_dh_prep:
override_dh_installdirs:
override_dh_auto_install:
	# Prepare the install script
	rm -rf ols.conf
	sed -i -e 's:SERVERROOT=/usr/local/lsws:SERVERROOT=$$1:g' install.sh
	sed -i -e 's:USE_LSPHP7=yes:USE_LSPHP7=no:g' install.sh
	sed -i -e 's:OPENLSWS_ADMINSSL=yes:OPENLSWS_ADMINSSL=no:g' install.sh
	sed -i -e 's:ln -sf "$$LSWS_HOME/fcgi-bin/lsphp5" "$$LSWS_HOME/fcgi-bin/lsphp":cd $$LSWS_HOME/fcgi-bin/; ln -sf lsphp5 ./lsphp; cd -:g' _in.sh
	sed -i -e 's:mkdir $$SERVERROOT:mkdir -p $$SERVERROOT:g' install.sh
	#sed -i -e 's:./_in.sh:./openlitespeed/_in.sh:g' openlitespeed/install.sh
	#sed -i -e 's:cp bin:cp openlitespeed/bin:g' openlitespeed/install.sh
	sed -i -e 's|s:%LSWS_CTRL%:$$LSWS_HOME/bin/lswsctrl:|s:%LSWS_CTRL%:/usr/local/lsws/bin/lswsctrl:|g' functions.sh
	./install.sh $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws	
	rm -f $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/adminpasswd 
	rm -f $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/conf/htpasswd
	# Move the modules to correct path/package
	MOD_SRC="$(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/modules/modpagespeed.so"
	MOD_DIR="$(BUILD_ROOT)/debian/ols-pagespeed"
	MOD_DST="$$MOD_DIR/usr/local/lsws/modules/"
	if [ -f "$(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/modules/modpagespeed.so" ]; then \
		mkdir -p "$(BUILD_ROOT)/debian/ols-pagespeed"; \
		mv "$(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/modules/modpagespeed.so" "$(BUILD_ROOT)/debian/ols-pagespeed"; \
	else \
		echo "Skipping ols-pagespeed because modpagespeed.so not found"; \
	fi
	mkdir -p $(BUILD_ROOT)/debian/ols-modsecurity/usr/local/lsws/modules/
	mv $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/modules/mod_security.so $(BUILD_ROOT)/debian/ols-modsecurity/usr/local/lsws/modules/
	# Have Default PHP be 83 and have admin panel run php 83 with 83 modules
	sed -i -e 's:fcgi-bin/lsphp:lsphp83/bin/lsphp:g' $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/conf/httpd_config.conf
	sed -i -e 's|extension_dir = ./|extension_dir = /usr/local/lsws/lsphp83/lib/php/20230831|g' $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/conf/php.ini
	# Fix admpass.sh for 24.04
	sed -i -e 's|admin_php|admin_php -c /usr/local/lsws/admin/conf/php.ini|g' $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/misc/admpass.sh
	# Fix admin_config.xml for SSL
	rm -f $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/conf/admin_config.conf
	cp -pr admin/conf/admin_config_ssl.conf.in $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/conf/admin_config.conf
	sed -i -e "s:%ADMIN_PORT%:7080:g" $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/conf/admin_config.conf
	sed -i -e "s:%SSL_HOSTNAME%:webadmin:g" $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/conf/admin_config.conf
	#Fix .rc files for proper permissions and path
	chmod u+w $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/misc/lsws.rc
	sed "s:%LSWS_CTRL%:/usr/local/lsws/bin/lswsctrl:" admin/misc/lsws.rc.in > $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/misc/lsws.rc
	chmod u+w $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/misc/lsws.rc.gentoo
	sed "s:%LSWS_CTRL%:/usr/local/lsws/bin/lswsctrl:" admin/misc/lsws.rc.gentoo.in > $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/misc/lsws.rc.gentoo
	sed -i -e 's:-e $${path}/$${AP_PROC}.service:true:g' $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/misc/rc-inst.sh
	sed -i -e 's:cp -f $${CURDIR}/lshttpd.service $${SYSTEMDDIR}/lshttpd.service:cp -f $${CURDIR}/lshttpd.service $${SYSTEMDDIR}/lshttpd.service\n ln -sf $${SYSTEMDDIR}/lshttpd.service $${SYSTEMDDIR}/lsws.service:g' $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/admin/misc/rc-inst.sh
	echo 'DEB' > $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/PLAT

override_dh_install:
	dh_install
	# rm -f debian/openlitespeed/usr/local/lsws/adminpasswd
override_dh_installdocs:
	mkdir -p $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed
	chmod u+w $(BUILD_ROOT)/debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed
	cp -a GPL.txt debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed
	cp debian/README.Debian debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed/README.Debian
	cp debian/copyright debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed/copyright

override_dh_installchangelogs:
	cp debian/changelog debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed/changelog.Debian
	chmod -R go=rX debian/openlitespeed/usr/local/lsws/share/doc
	chmod -R u\+rw debian/openlitespeed/usr/local/lsws/share/doc

override_dh_strip_nondeterminism:
override_dh_usrlocal:
