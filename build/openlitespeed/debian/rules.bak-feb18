#!/usr/bin/make -f
# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
DH_VERBOSE = 1
export DH_OPTIONS=-v

# see EXAMPLES in dpkg-buildflags(1) and read /usr/share/dpkg/*
DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/default.mk

# see FEATURE AREAS in dpkg-buildflags(1)
#export DEB_BUILD_MAINT_OPTIONS = hardening=+all

# see ENVIRONMENT in dpkg-buildflags(1)
# package maintainers to append CFLAGS
#export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
# package maintainers to append LDFLAGS
#export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed


# main packaging script based on dh7 syntax
%:
	dh $@  --with autotools-dev

# debmake generated override targets
# This is example for Cmake (See http://bugs.debian.org/641051 )
#override_dh_auto_configure:
#	dh_auto_configure -- \
#	-DCMAKE_LIBRARY_PATH=$(DEB_HOST_MULTIARCH)

BUILD_ROOT=$(shell pwd)

############################################################################################

#			#dh clean sequence#
			
#override_dh_testdir:
#override_dh_autoclean:
#override_dh_clean:

############################################################################################

#			#dh build sequence#
			
#override_dh_testdir:
override_dh_auto_configure:
	dh_auto_configure -- prefix=/usr/local/lsws

	touch configure-stamp

override_dh_auto_build:
	make -j8
	mkdir -p debian/openlitespeed/usr/local/lsws/admin/fcgi-bin/
	cp -a dist/fcgi-bin/admin_php debian/openlitespeed/usr/local/lsws/admin/fcgi-bin/admin_php
	make -j8 -C src/modules/pagespeed/ -f Makefile.f

	touch build-stamp


override_dh_auto_test:

############################################################################################

#			#dh binary sequence: both binary-arch & binary-indep
#			#binary-arch using -a option, binary-indep using -i option
			
#override_dh_testroot:
override_dh_prep:
override_dh_installdirs:
override_dh_auto_install:
	make -j1 install \
	DESTDIR=$(BUILD_ROOT)/debian/openlitespeed \
	AM_UPDATE_INFO_DIR=no
	
	chmod u+w debian/openlitespeed/usr/local/lsws/admin/misc/lsws.rc
	chmod u+w debian/openlitespeed/usr/local/lsws/admin/misc/lsws.rc.gentoo
	
	sed "s:%LSWS_CTRL%:/usr/local/lsws/bin/lswsctrl:" dist/admin/misc/lsws.rc.in > debian/openlitespeed/usr/local/lsws/admin/misc/lsws.rc
	
	sed "s:%LSWS_CTRL%:/usr/local/lsws/bin/lswsctrl:" dist/admin/misc/lsws.rc.gentoo.in > debian/openlitespeed/usr/local/lsws/admin/misc/lsws.rc.gentoo
	mkdir -p $(BUILD_ROOT)/debian/ols-pagespeed/usr/local/lsws/modules/
	cp -a $(BUILD_ROOT)/src/modules/pagespeed/modpagespeed.so debian/ols-pagespeed/usr/local/lsws/modules/
	
	make clean
	./configure --prefix=/usr/local/lsws --enable-spdy --with-zlib=/usr --with-pcre=/usr --enable-debug
	make
	cp $(BUILD_ROOT)/src/openlitespeed debian/openlitespeed/usr/local/lsws/bin/openlitespeed.dbg
	rm -f debian/openlitespeed/usr/local/lsws/admin/fcgi-bin/admin_php
	rm -f debian/openlitespeed/usr/local/lsws/admin/fcgi-bin/admin_php.bak
	cp -a dist/fcgi-bin/admin_php debian/openlitespeed/usr/local/lsws/admin/fcgi-bin/admin_php
	cp -a dist/fcgi-bin/admin_php debian/openlitespeed/usr/local/lsws/fcgi-bin/lsphp5
	cd debian/openlitespeed/usr/local/lsws/fcgi-bin/
	rm -f lsphp
	ln -sfn lsphp5 ./lsphp
	cd -




override_dh_install:
override_dh_installdocs:
	install -g 0 -o 0 -d debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed
	cp -a GPL.txt debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed
	cp -a README.md debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed
	chown -R 0:0 debian/openlitespeed/usr/local/lsws/share/doc
	chmod -R go=rX debian/openlitespeed/usr/local/lsws/share/doc
	chmod -R u\+rw debian/openlitespeed/usr/local/lsws/share/doc
	install -g 0 -o 0 -m 644 -p debian/README.Debian debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed/README.Debian
	install -g 0 -o 0 -m 644 -p debian/copyright debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed/copyright

override_dh_installchangelogs:
	install -o 0 -g 0 -p -m644 debian/changelog debian/openlitespeed/usr/local/lsws/share/doc/openlitespeed/changelog.Debian

override_dh_strip_nondeterminism:
#override_dh_installexamples:
#override_dh_installman:
#override_dh_installcatalogs:
#override_dh_installcron:
#override_dh_installdebconf:
#override_dh_installemacsen:
#override_dh_installifupdown:
#override_dh_installinfo:
#override_dh_installinit:
#override_dh_installmenu:

#override_dh_installmime:
#override_dh_installmodules:
#override_dh_installlogcheck:
#override_dh_installlogrotate:
#override_dh_installpam:
#override_dh_installppp:
#override_dh_installudev:
#override_dh_installwm:
#override_dh_installxfonts:

#override_dh_bugfiles:
#override_dh_lintian:
#override_dh_gconf:
#override_dh_icons:

#override_dh_perl:
override_dh_usrlocal:
override_dh_link:
	rm -f debian/openlitespeed/usr/local/lsws/admin/html
	ln -sf html.open debian/openlitespeed/usr/local/lsws/admin/html
	rm -f debian/openlitespeed/usr/local/lsws/bin/lswsctrl
	ln -sf lswsctrl.open debian/openlitespeed/usr/local/lsws/bin/lswsctrl
	rm -f debian/openlitespeed/usr/local/lsws/bin/litespeed
	ln -sf lshttpd debian/openlitespeed/usr/local/lsws/bin/litespeed
	rm -f debian/openlitespeed/usr/local/lsws/bin/lshttpd
	ln -sf openlitespeed debian/openlitespeed/usr/local/lsws/bin/lshttpd
	rm -f debian/openlitespeed/usr/local/lsws/fcgi-bin/lsphp
	ln -sf lsphp5 debian/openlitespeed/usr/local/lsws/fcgi-bin/lsphp

#override_dh_compress:
#override_dh_fixperms:

#the following 3 steps are for binary-arch only
####################
#override_dh_strip:
#override_dh_makeshlibs:
#override_dh_shlibdeps:
#####################

#override_dh_installdeb:
#override_dh_gencontrol:
#override_dh_md5sums:
#override_dh_builddeb:

#			#end of binary sequence#
